# Browser Service - Actual Usage Guide

This service uses **Firefox in incognito mode only** for all automations.

## üéØ What You Actually Use

- **Browser:** Firefox only (headless)
- **Session Type:** Incognito only (for privacy and clean state)
- **Factory Pattern:** Still implemented for clean code architecture

## üèóÔ∏è Why Factory Pattern If Only Firefox?

The Factory Design Pattern provides:

1. **Clean Architecture** - Separation of concerns
2. **Testability** - Easy to mock for unit tests
3. **Maintainability** - Clear code organization
4. **Future-Proofing** - Easy to extend if requirements change
5. **Professional Design** - Industry best practices

**You won't use the other browser types, but the pattern makes the code better.**

---

## üìù Simplified Worker Usage

### Basic Pattern (All You Need)

```python
from services.browser_client import PlaywrightBrowserClient

def execute_automation(job_id, job_params):
    """
    Standard pattern for all your automations.
    Always Firefox incognito mode.
    """
    
    # Initialize client
    browser = PlaywrightBrowserClient(
        base_url=job_params['browser_service_url'],
        auth_token=job_params['browser_service_token']
    )
    
    try:
        # 1. Create session (always incognito)
        browser.create_session(
            viewport_width=1920,
            viewport_height=1080
        )
        
        # 2. Navigate
        browser.navigate("https://portal.example.com")
        
        # 3. Login
        browser.fill("#username", job_params['username'])
        browser.fill("#password", job_params['password'])
        browser.click("#login-button")
        
        # 4. Submit TOTP (pre-generated by orchestrator)
        browser.submit_totp("#totp-input", job_params['totp_code'])
        
        # 5. Wait for page load
        browser.wait_for_selector("#dashboard", state=ElementState.VISIBLE)
        
        # 6. Extract data
        status = browser.get_text("#order-status")
        customer = browser.get_text("#customer-name")
        
        # 7. Capture evidence
        browser.screenshot(save_path=f"screenshots/{job_id}.png")
        
        return {
            'status': 'success',
            'data': {'status': status, 'customer': customer}
        }
        
    except Exception as e:
        # Capture error screenshot
        try:
            browser.screenshot(save_path=f"screenshots/{job_id}_error.png")
        except:
            pass
        raise
        
    finally:
        # Always cleanup
        browser.close_session()
```

### Context Manager Pattern (Even Simpler)

```python
def execute_automation(job_id, job_params):
    """
    Context manager automatically handles session creation/cleanup.
    """
    
    with PlaywrightBrowserClient(
        base_url=job_params['browser_service_url'],
        auth_token=job_params['browser_service_token']
    ) as browser:
        
        # Do automation
        browser.navigate("https://portal.example.com")
        browser.fill("#username", job_params['username'])
        browser.fill("#password", job_params['password'])
        browser.click("#login")
        browser.submit_totp("#totp", job_params['totp_code'])
        
        # Extract result
        result = browser.get_text("#result")
        
        return {'status': 'success', 'data': result}
    
    # Session automatically closed, even if error occurs
```

---

## üîÑ Converting Your Selenium Code

### Old (Selenium)

```python
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
import pyotp

class OctotelValidation:
    def __init__(self, job_id):
        self.driver = None
        
    def setup_driver(self):
        chrome_options = Options()
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--no-sandbox")
        self.driver = webdriver.Chrome(options=chrome_options)
    
    def login(self, username, password, totp_secret):
        self.driver.get("https://octotel.co.za/login")
        self.driver.find_element(By.ID, "username").send_keys(username)
        self.driver.find_element(By.ID, "password").send_keys(password)
        
        # Generate TOTP in worker (problematic!)
        totp = pyotp.TOTP(totp_secret)
        code = totp.now()
        self.driver.find_element(By.ID, "totp").send_keys(code)
        
    def cleanup(self):
        if self.driver:
            self.driver.quit()
```

### New (Playwright via Browser Service)

```python
from services.browser_client import PlaywrightBrowserClient

class OctotelValidation:
    def __init__(self, job_id, job_params):
        # Browser client instead of direct driver
        self.browser = PlaywrightBrowserClient(
            base_url=job_params['browser_service_url'],
            auth_token=job_params['browser_service_token']
        )
    
    def login(self, username, password, totp_code):
        # Create session (always Firefox incognito)
        self.browser.create_session()
        
        # Navigate and interact
        self.browser.navigate("https://octotel.co.za/login")
        self.browser.fill("#username", username)
        self.browser.fill("#password", password)
        
        # Use pre-generated TOTP from orchestrator
        self.browser.submit_totp("#totp", totp_code)
    
    def cleanup(self):
        self.browser.close_session()
```

**Key Changes:**
1. ‚ùå No driver setup - handled by browser service
2. ‚ùå No TOTP generation - comes from orchestrator
3. ‚úÖ Simple API calls instead of Selenium
4. ‚úÖ Always Firefox incognito (no config needed)

---

## üéØ Common Operations

### Navigation

```python
# Basic navigation
browser.navigate("https://example.com")

# With custom wait condition
browser.navigate(
    "https://slow-site.com",
    wait_until=WaitUntil.LOAD,  # or DOMCONTENTLOADED, NETWORKIDLE
    timeout=60000  # 60 seconds
)
```

### Element Interactions

```python
# Fill input
browser.fill("#username", "user@example.com")

# Click button
browser.click("#submit-button")

# Force click (if element blocked)
browser.click("#hidden-button", force=True)

# Submit TOTP (special helper)
browser.submit_totp("#totp-input", totp_code)  # Auto-presses Enter
```

### Data Extraction

```python
# Get text
status = browser.get_text("#order-status")

# Get attribute
link_url = browser.get_attribute("#download-link", "href")

# Multiple extractions
data = {
    'status': browser.get_text("#status"),
    'customer': browser.get_text("#customer"),
    'date': browser.get_text("#date")
}
```

### Wait Operations

```python
# Wait for element to be visible
browser.wait_for_selector(
    "#dashboard",
    state=ElementState.VISIBLE,
    timeout=30000
)

# Wait for element to disappear
browser.wait_for_selector(
    "#loading-spinner",
    state=ElementState.HIDDEN,
    timeout=10000
)
```

### Screenshots

```python
# Page screenshot
browser.screenshot(save_path=f"screenshots/{job_id}.png")

# Full page screenshot
browser.screenshot(
    full_page=True,
    save_path=f"screenshots/{job_id}_full.png"
)

# Get bytes without saving
screenshot_bytes = browser.screenshot()
```

---

## üîß Configuration

### Environment Variables (Minimal)

You only need these:

```bash
JWT_SECRET=your-secret-key              # Required
HEADLESS=true                            # Default: true
DEFAULT_TIMEOUT=30000                    # Default: 30 seconds
MAX_SESSIONS=5                           # Default: 5
LOG_LEVEL=INFO                           # Default: INFO
```

**You don't need to set:**
- `BROWSER_TYPE` - Always Firefox
- `SESSION_TYPE` - Always incognito

---

## üìä Performance Tips

### 1. Reuse Sessions When Possible

```python
# Create once
browser.create_session()

# Multiple operations
browser.navigate("https://portal.com/page1")
data1 = browser.get_text("#data1")

browser.navigate("https://portal.com/page2")
data2 = browser.get_text("#data2")

# Close once
browser.close_session()
```

### 2. Adjust Timeouts for Slow Pages

```python
# Increase timeout for slow operations
browser.navigate("https://slow-site.com", timeout=60000)
browser.click("#slow-button", timeout=45000)
```

### 3. Use Appropriate Wait Conditions

```python
# Fast - waits only for DOM
browser.navigate(url, wait_until=WaitUntil.DOMCONTENTLOADED)

# Balanced - waits for page load event (default)
browser.navigate(url, wait_until=WaitUntil.LOAD)

# Thorough - waits for network to be idle
browser.navigate(url, wait_until=WaitUntil.NETWORKIDLE)
```

### 4. Handle Errors Gracefully

```python
try:
    browser.click("#optional-popup-close", timeout=5000)
except BrowserServiceError:
    # Popup didn't appear, continue
    pass

# Continue with main workflow
browser.fill("#username", username)
```

---

## üß™ Testing Your Integration

### Test Script

```bash
# Set variables
export JWT_TOKEN="your-token"
export BASE_URL="http://browser-service:8080"

# Run test script
./test_api.sh
```

### Manual Test

```python
# test_browser.py
from client.browser_client import PlaywrightBrowserClient

def test_basic_flow():
    browser = PlaywrightBrowserClient(
        base_url="http://localhost:8080",
        auth_token="your-jwt-token"
    )
    
    try:
        browser.create_session()
        browser.navigate("https://example.com")
        title = browser.get_text("h1")
        print(f"Page title: {title}")
        assert title == "Example Domain"
        print("‚úÖ Test passed!")
    finally:
        browser.close_session()

if __name__ == "__main__":
    test_basic_flow()
```

---

## üö´ What You Don't Need

### Don't Use (Even Though They Exist)

```python
# Don't specify browser type - always Firefox
browser_manager.initialize(browser_type='firefox')  # ‚ùå Unnecessary

# Don't specify session type - always incognito
browser.create_session(session_type='incognito')    # ‚ùå Unnecessary

# Don't generate TOTP in worker
import pyotp                                         # ‚ùå Remove this
totp = pyotp.TOTP(secret).now()                     # ‚ùå Don't do this
```

### Just Use (Simple)

```python
# ‚úÖ Simple - always Firefox incognito
browser.create_session()

# ‚úÖ TOTP comes from orchestrator
browser.submit_totp("#totp", job_params['totp_code'])
```

---

## üìù Complete Real Example

```python
"""
Octotel Order Validation
Uses: Firefox (incognito), Pre-generated TOTP
"""
from services.browser_client import PlaywrightBrowserClient, ElementState
from pathlib import Path
import logging

logger = logging.getLogger(__name__)

def execute(job_id, parameters):
    """
    Execute Octotel validation job.
    
    Parameters from orchestrator:
        - browser_service_url: Browser service endpoint
        - browser_service_token: JWT token
        - totp_code: Pre-generated TOTP code
        - username: Octotel username
        - password: Octotel password
        - order_id: Order to validate
    """
    
    browser = PlaywrightBrowserClient(
        base_url=parameters['browser_service_url'],
        auth_token=parameters['browser_service_token'],
        timeout=60
    )
    
    screenshot_dir = Path(f"screenshots/{job_id}")
    screenshot_dir.mkdir(parents=True, exist_ok=True)
    
    try:
        logger.info(f"Job {job_id}: Starting validation")
        
        # Create session (Firefox incognito)
        browser.create_session()
        
        # Navigate to login
        browser.navigate("https://octotel-portal.co.za/login")
        
        # Login
        browser.fill("#username", parameters['username'])
        browser.fill("#password", parameters['password'])
        browser.click("#login-button")
        
        # Wait for TOTP prompt
        browser.wait_for_selector("#totp-input", state=ElementState.VISIBLE)
        
        # Submit pre-generated TOTP
        browser.submit_totp("#totp-input", parameters['totp_code'])
        
        # Wait for dashboard
        browser.wait_for_selector("#dashboard", timeout=30000)
        
        # Navigate to order
        order_url = f"https://octotel-portal.co.za/orders/{parameters['order_id']}"
        browser.navigate(order_url)
        
        # Extract order data
        order_data = {
            'status': browser.get_text("#order-status"),
            'customer': browser.get_text("#customer-name"),
            'address': browser.get_text("#service-address"),
            'install_date': browser.get_text("#installation-date")
        }
        
        # Capture evidence
        browser.screenshot(
            full_page=True,
            save_path=str(screenshot_dir / "validation_complete.png")
        )
        
        logger.info(f"Job {job_id}: Validation complete")
        
        return {
            'status': 'success',
            'order_data': order_data,
            'job_id': job_id
        }
        
    except Exception as e:
        logger.error(f"Job {job_id}: Validation failed: {e}")
        
        # Error screenshot
        try:
            browser.screenshot(
                save_path=str(screenshot_dir / "error.png")
            )
        except:
            pass
        
        return {
            'status': 'failed',
            'error': str(e),
            'job_id': job_id
        }
        
    finally:
        browser.close_session()
```

---

## ‚úÖ Summary

**What You Use:**
- Firefox (only browser)
- Incognito mode (only session type)
- Browser service API (REST calls)
- Pre-generated TOTP (from orchestrator)
- Factory pattern (for clean code)

**What You Don't Use:**
- Chromium/Edge options (exist but not used)
- Standard/Mobile session types (exist but not used)
- Direct Selenium (replaced by browser service)
- Worker TOTP generation (moved to orchestrator)

**Result:**
- ‚úÖ Clean, maintainable code
- ‚úÖ Professional architecture
- ‚úÖ Easy to test and extend
- ‚úÖ Simplified worker code
- ‚úÖ Centralized TOTP management

**The factory pattern makes the code better, even though you only use Firefox!**
